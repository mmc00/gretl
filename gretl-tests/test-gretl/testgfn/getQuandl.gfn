<?xml version="1.0" encoding="UTF-8"?>
<gretl-functions>
<gretl-function-package name="getQuandl" ID="1412769575" minver="1.9.12">
<author>Yi-Nung Yang</author>
<version>0.62</version>
<date>2014-10-08</date>
<description>Download data from Quandl.com, a &quot;data platform&quot;</description>
<help>
This package is to make it easy and free to download and share data from www.quandl.com, which is a &quot;data platform&quot; that collects numerical data published by hundreds of different sources, and host them on a single easy-to-use website.See also Quandl API @ http://www.quandl.com/help/api. 

==Change log==
2014.10.21: ver.0.62 fix errors in downloading stock close prices from source {WIKI}
2014.10.21: ver.0.61 -First (beta) testing version release
            known issues: daily-data may work for gretl 1.9.12
</help>
<gretl-function name="getQuandl" type="list">
 <params count="9">
  <param name="sQcode" type="string" optional="true">
<description>Quandl Codes</description>
  </param>
  <param name="s1" type="string" optional="true">
<description>Sample date from (樣本開始自) YYYY-MM-DD: </description>
  </param>
  <param name="s2" type="string" optional="true">
<description>to (樣本結束至) YYYY-MM-DD:</description>
  </param>
  <param name="nFrequency" type="int" min="0" max="5" default="0">
<description>Frequency (資料頻率)</description>
<labels count="6">
"current sample 依目前樣本" "daily 日資料" "weekly 週資料" "monthly 月資料" "quarterly 季資料" "annual 年資料" </labels>
  </param>
  <param name="source" type="int" min="1" max="5" default="1">
<description>Source (資料庫):</description>
<labels count="5">
"ODA (Open Data for Africa initiative from IMF)" "World Bank" "United Nations" "FRED Economic Data" "WIKI for stock prices (股票資料)" </labels>
  </param>
  <param name="sScode" type="string" optional="true">
<description>Use your own Source Code (填入自訂資料庫代碼)</description>
  </param>
  <param name="bUserCode" type="bool" default="0">
<description>Use your own code (使用自訂資料庫代碼 )? </description>
  </param>
  <param name="sUserCode" type="string" optional="true">
<description>Fill your code, i.e., {Source code}/{COUNTRY}_{INDICATOR} (填入代碼):</description>
  </param>
  <param name="sAuthToken" type="string" optional="true">
<description>Quandl Auth Token (Quandl 授權碼):</description>
  </param>
 </params>
<code>if !isnull(sQcode)
  if isnull(s1)
    string s1=start_date(obslabel($t1))
  endif
  if isnull(s2)
    string s2=end_date(obslabel($t2))
  endif
  if isnull(sScode)
    sScode=&quot;&quot;
  endif
  if !bUserCode
    sUserCode=&quot;&quot;
  endif
  if isnull(sAuthToken)
    string sAuthToken=&quot;&quot;
  endif
  URL=getQuandl_url(sQcode,s1,s2,nFrequency,source,sScode,bUserCode,sUserCode,sAuthToken)
  printf &quot;URL=%s\n&quot;,URL
  /*
  #catch append &quot;@dotdir/tmpM.csv&quot;
  append &quot;@dotdir/tmpM.csv&quot;
  */
  scalar err=0
  string req=&quot;&quot;
  sName=write_tmpCSV(URL,&amp;err,req)
  # ---- 自訂資料庫代碼時, 欄位名稱不一定 = Value
  #      sScode=&quot;QUANDL&quot; 時, 欄位 = &quot;Rate&quot;
  string sColname=&quot;Value&quot;
  if source=1
    string src=&quot;ODA&quot;
  endif
  if source=2
    string src=&quot;WORLDBANK&quot;
  endif
  if source=3
    string src=&quot;UNDATA&quot;
  endif
  if source=4
    string src=&quot;FRED&quot;
  endif
  if source=5  # --- 自訂資料庫名稱
    string src=&quot;WIKI&quot;
    string sColname=&quot;Close&quot;
  endif
  if sScode!=&quot;&quot;
    string src=sScode
    if sScode=&quot;BOE&quot;
      string sColname=&quot;Value&quot;
    elif sScode=&quot;QUANDL&quot;
      string sColname=&quot;Rate&quot;
    elif sScode=&quot;ECB&quot;
      string sColname=&quot;Value&quot;
    elif sScode=&quot;BNP&quot;
      string sColname=sQcode
      string sQcode=strsub(sQcode,&quot;/&quot;,&quot;_&quot;)
      #printf &quot;sQcode=%s **************\n&quot;,sQcode
      #printf &quot;sColname=%s **************\n&quot;,sColname
    elif sScode=&quot;WIKI&quot;
      string sColname=&quot;Close&quot;
    endif
  endif
  if sName==&quot;&quot;
    printf &quot;========================= getQuandl(): ==================================\n&quot;
    printf &quot;Error %d! Requested entity '%s' does not exist in '%s'.\n&quot;, err,sQcode,src
    printf &quot;=========================================================================\n&quot;
    string sQcode=&quot;&quot;
    list tmplist= const
  else
    # 用join 指令取代 append 可自動處理時間序列資料樣本對齊的問題
    #join &quot;@sName&quot; Value --tkey=Date --data=&quot;Value&quot;
    if src=&quot;WIKI&quot; || source=5
      loop foreach j Open High Low Close Volume
        # --- 舊程式碼, 只能用來下載 close 價
        #                    string sQcode=sQcode~&quot;_close&quot;
        #                    catch join &quot;@sName&quot; @sQcode --tkey=Date --data=@sColname
        string tmp=sQcode
        string tmp=tmp~&quot;_$j&quot;
        catch join &quot;@sName&quot; @tmp --tkey=Date --data=$j
      endloop
    else
      # 在1.9.92 己不能用 --time=&quot;%Y-%m-%d&quot;
      catch join &quot;@sName&quot; @sQcode --tkey=Date --data=@sColname
    endif
    err = $error
    if err
      printf &quot;There is an Error: %d! ====================&gt;.\n&quot;, err
      #catch join &quot;@sName&quot; @sQcode --tkey=Date --data=@sColname --time=&quot;%Y-%m-%d&quot;
    else
      printf &quot;NO Error %d! ----&gt;.\n&quot;, err
    endif
    if src=&quot;WIKI&quot; || source=5
      loop foreach j Open High Low Close Volume
        setinfo @sQcode_$j -d &quot;quandl source: @src&quot;
        list tmplist= const @sQcode_*
      endloop
    else
      setinfo @sQcode -d &quot;quandl source: @src&quot;
      list tmplist= const @sQcode
    endif
  endif
  return tmplist
else
  printf &quot;\n================ Error! ==================\n&quot;
  printf &quot; There is no Quandl code!!!!!\n&quot;
  printf &quot; Please enter the Quandl code.\n&quot;
  printf &quot;==========================================\n&quot;
endif
</code>
</gretl-function>
<gretl-function name="write_tmpCSV" type="string" private="1">
 <params count="3">
  <param name="URL" type="string"/>
  <param name="err" type="scalarref"/>
  <param name="req" type="string"/>
 </params>
<code>rnd = randgen1(i,1,9999)
if $windows
  sprintf fname &quot;@dotdir\\yg_%04d.csv&quot;, rnd
else
  sprintf fname &quot;@dotdir/yg_%04d.csv&quot;, rnd
endif
#URL = getQuandl_url(symbol, req)
# print URL
catch s = readfile(URL)
err = $error
if !err
  #check = strstr(s, &quot;404 Not Found&quot;)
  check = strstr(s, &quot;Requested entity does not exist.&quot;)
  #printf &quot;err=%d, s=%s, check=%s, len=%d\n&quot;,err,s,check,strlen(check)
  if strlen(check) &gt; 0
    err = 404
    #printf &quot;Error %d! Requested entity does not exist.\n&quot;, err
  endif
else
  printf &quot;Error %d!\n&quot;, err
endif
if !err
  outfile &quot;@fname&quot; --write
  print s
  outfile &quot;@fname&quot; --close
else
  string fname =null
endif
return fname
</code>
</gretl-function>
<gretl-function name="getQuandl_url" type="string" private="1">
 <params count="9">
  <param name="sQcode" type="string" optional="true">
<description>Quandl Codes</description>
  </param>
  <param name="s1" type="string" optional="true">
<description>Sample date from (樣本開始自) YYYY-MM-DD: </description>
  </param>
  <param name="s2" type="string" optional="true">
<description>to (樣本結束至) YYYY-MM-DD:</description>
  </param>
  <param name="nFrequency" type="int" min="0" max="5" default="0">
<description>Frequency (資料頻率)</description>
<labels count="6">
"current sample 依目前樣本" "daily 日資料" "weekly 週資料" "monthly 月資料" "quarterly 季資料" "annual 年資料" </labels>
  </param>
  <param name="source" type="int" min="1" max="5" default="1">
<description>Source (資料庫):</description>
<labels count="5">
"ODA (Open Data for Africa initiative from IMF)" "World Bank" "United Nations" "FRED Economic Data" "WIKI for stock prices (股票資料)" </labels>
  </param>
  <param name="sScode" type="string" optional="true">
<description>Use your own Source Code (填入自訂資料庫代碼)</description>
  </param>
  <param name="bUserCode" type="bool" default="0">
<description>Use your own code (使用自訂的代碼 )? </description>
  </param>
  <param name="sUserCode" type="string" optional="true">
<description>Fill your code, i.e., {Source code}/{COUNTRY}_{INDICATOR} (填入代碼):</description>
  </param>
  <param name="sAuthToken" type="string" optional="true">
<description>Quandl Auth Token (Quandl 授權碼):</description>
  </param>
 </params>
<code>baseURL=&quot;http://www.quandl.com/api/v1/datasets/&quot;
# get the from-date and to-date from current sample range
if isnull(s1)
  string s1=start_date(obslabel($t1))
endif
if isnull(s2)
  string s2=end_date(obslabel($t2))
endif
if isnull(sAuthToken)
  string sAuthToken=&quot;&quot;
else
  string sAuthToken=&quot;&amp;auth_token=&quot; ~ sAuthToken
endif
# --- detect the sample data frequency ---
if nFrequency =  0
  if (($pd = 5)||($pd = 6)||($pd = 7))
    nFrequency=1
  elif $pd=52
    nFrequency=2
  elif $pd=12
    nFrequency=3
  elif $pd=4
    nFrequency=4
  elif $pd=1
    nFrequency=5
  endif
endif
if nFrequency =  1    # daily
  collapse=&quot;daily&quot;
elif nFrequency =  2  # weekly
  collapse=&quot;weekly&quot;
elif nFrequency =  3  # monthly
  collapse=&quot;monthly&quot;
elif nFrequency =  4  # quarterly
  collapse=&quot;quarterly&quot;
elif nFrequency =  5  # yearly
  collapse=&quot;yearly&quot;
endif
# ---- use the fullcode provided by user's own input -----
if bUserCode
  string sFullcode=baseURL~ sUserCode ~ &quot;.csv&quot;
else
  if source=1
    string src=&quot;ODA&quot;
  endif
  if source=2
    string src=&quot;WORLDBANK&quot;
  endif
  if source=3
    string src=&quot;UNDATA&quot;
  endif
  if source=4
    string src=&quot;FRED&quot;
  endif
  if source=5  # --- 自訂資料庫名稱
    string src=&quot;WIKI&quot;
  endif
  #if !isnull(sScode)
  #printf &quot;len(sScode)=%d\n&quot;,strlen(sScode)
  if sScode!=&quot;&quot;
    string src=sScode
  endif
  string sFullcode=baseURL~src ~ &quot;/&quot; ~ sQcode ~ &quot;.csv&quot;
endif
sFullcode = sFullcode ~ &quot;?collapse=&quot; ~ collapse ~ &quot;&amp;trim_start=&quot;~ s1 ~ &quot;&amp;trim_end=&quot; ~ s2 ~ &quot;&amp;sort_order=asc&quot; ~ sAuthToken
#printf &quot;--------------&gt; source=%d\n&quot;,source
#    printf &quot;sFullcode=%s\n&quot;,sFullcode
return sFullcode
</code>
</gretl-function>
<gretl-function name="start_date" type="string" private="1">
 <params count="1">
  <param name="sDate" type="string"/>
 </params>
<code>if (($pd = 5)||($pd = 6)||($pd = 7))
  sDate1=sDate
elif $pd=52
  sDate1=sDate
elif $pd=12
  sDate1=strsub(sDate,&quot;:&quot;,&quot;-&quot;)~&quot;-01&quot;
elif $pd=4
  sDate1=strsub(sDate,&quot;:1&quot;,&quot;-01-01&quot;)
  sDate1=strsub(sDate1,&quot;:2&quot;,&quot;-04-01&quot;)
  sDate1=strsub(sDate1,&quot;:3&quot;,&quot;-07-01&quot;)
  sDate1=strsub(sDate1,&quot;:4&quot;,&quot;-09-01&quot;)
elif $pd=1
  sDate1=sDate ~ &quot;-01-01&quot;
endif
return sDate1
</code>
</gretl-function>
<gretl-function name="end_date" type="string" private="1">
 <params count="1">
  <param name="sDate" type="string"/>
 </params>
<code>if (($pd = 5)||($pd = 6)||($pd = 7))
  sDate1=sDate
elif $pd=52
  sDate1=sDate
elif $pd=12
  sDate1=strsub(sDate,&quot;:01&quot;,&quot;-01-31&quot;)
  sDate1=strsub(sDate1,&quot;:02&quot;,&quot;-02-29&quot;)
  sDate1=strsub(sDate1,&quot;:03&quot;,&quot;-03-31&quot;)
  sDate1=strsub(sDate1,&quot;:04&quot;,&quot;-04-30&quot;)
  sDate1=strsub(sDate1,&quot;:05&quot;,&quot;-05-31&quot;)
  sDate1=strsub(sDate1,&quot;:06&quot;,&quot;-06-30&quot;)
  sDate1=strsub(sDate1,&quot;:07&quot;,&quot;-07-31&quot;)
  sDate1=strsub(sDate1,&quot;:08&quot;,&quot;-08-31&quot;)
  sDate1=strsub(sDate1,&quot;:09&quot;,&quot;-09-30&quot;)
  sDate1=strsub(sDate1,&quot;:10&quot;,&quot;-10-31&quot;)
  sDate1=strsub(sDate1,&quot;:11&quot;,&quot;-11-30&quot;)
  sDate1=strsub(sDate1,&quot;:12&quot;,&quot;-12-31&quot;)
elif $pd=4
  sDate1=strsub(sDate,&quot;:1&quot;,&quot;-01-31&quot;)
  sDate1=strsub(sDate1,&quot;:2&quot;,&quot;-04-30&quot;)
  sDate1=strsub(sDate1,&quot;:3&quot;,&quot;-07-31&quot;)
  sDate1=strsub(sDate1,&quot;:4&quot;,&quot;-09-30&quot;)
elif $pd=1
  sDate1=sDate ~ &quot;-12-31&quot;
endif
return sDate1
</code>
</gretl-function>
<sample-script>
include getQuandl.gfn
nulldata 50
setobs 1 1964
# 台灣、美國、中國名目 GDP per capital in US dollars
xlist = getQuandl(&quot;TWN_NGDPDPC&quot;, null, null, 0, 1, null, 0, null, &quot;&quot;)
xlist = getQuandl(&quot;USA_NGDPDPC&quot;, null, null, 0, 1, null, 0, null, &quot;&quot;)
xlist = getQuandl(&quot;CHN_NGDPDPC&quot;, null, null, 0, 1, null, 0, null, &quot;&quot;)
xlist = getQuandl(&quot;JPN_NGDPDPC&quot;, null, null, 0, 1, null, 0, null, &quot;&quot;)
xlist = getQuandl(&quot;KOR_NGDPDPC&quot;, null, null, 0, 1, null, 0, null, &quot;&quot;)
</sample-script>
</gretl-function-package>
</gretl-functions>

